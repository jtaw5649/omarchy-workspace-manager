#!/usr/bin/env bash
# Omarchy Workspace Manager entrypoint.

set -euo pipefail
IFS=$'\n\t'

root_dir="$(cd -P -- "$(dirname -- "${BASH_SOURCE[0]}")/.." && pwd)"
core_lib="$root_dir/lib/core.sh"
if [[ ! -f "$core_lib" ]]; then
	echo "error: missing core library at $core_lib" >&2
	exit 1
fi
# shellcheck source=/dev/null
source "$core_lib"

owm_usage() {
	cat <<'USAGE'
Usage: omarchy-workspace-manager <command> [options]

Commands:
  paired        Paired workspace operations
  daemon        Event loop supervisor for Hyprland
  dispatch      Force workspace assignments immediately
  setup         Installer utilities for Hyprland integration
  uninstall     Remove Omarchy Workspace Manager files
  checkpoints   Inspect configuration checkpoints
  help          Show this help message
USAGE
}

main() {
	if [[ $# -eq 0 ]]; then
		owm_usage
		exit 1
	fi

	local command="$1"
	shift || true

	if [[ "$command" != "help" && "$command" != "-h" && "$command" != "--help" && "$command" != "uninstall" ]]; then
		owm_validate_runtime
	fi

	case "$command" in
	help | -h | --help)
		owm_usage
		;;
	paired)
		owm_source "lib/cli/paired.sh"
		owm_cli_paired "$@"
		;;
	daemon)
		owm_source "lib/cli/daemon.sh"
		owm_cli_daemon "$@"
		;;
	dispatch)
		owm_source "lib/cli/dispatch.sh"
		owm_cli_dispatch "$@"
		;;
	setup)
		owm_source "lib/cli/setup.sh"
		owm_cli_setup "$@"
		;;
	uninstall)
		owm_source "lib/cli/uninstall.sh"
		owm_cli_uninstall "$@"
		;;
	checkpoints)
		owm_source "lib/cli/checkpoints.sh"
		owm_cli_checkpoints "$@"
		;;
	*)
		owm_die "unknown command '$command'"
		;;
	esac
}

main "$@"
