#!/usr/bin/env bash
set -euo pipefail

root_dir="$(cd -P "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
source "$root_dir/lib/core.sh"

owm_ensure_setup() {
	local config_dir="$HOME/.config/omarchy-workspace-manager"
	[[ -f "$config_dir/bindings.conf" ]] && return 0

	echo "First run detected, running setup..."
	owm_source "lib/cli/setup.sh"
	owm_cli_setup install
}

owm_usage() {
	cat <<'USAGE'
Usage: omarchy-workspace-manager <command> [args]

Commands:
  paired    Paired workspace operations (switch, cycle, move-window)
  daemon    Event loop for monitor changes
  setup     Generate/remove Hyprland fragments
  waybar    Waybar custom module output
  help      Show this help
USAGE
}

case "${1:-}" in
	paired)
		owm_ensure_setup
		shift; owm_source "lib/cli/paired.sh"; owm_cli_paired "$@"
		;;
	daemon)
		owm_ensure_setup
		shift; owm_source "lib/cli/daemon.sh"; owm_cli_daemon "$@"
		;;
	setup)
		shift; owm_source "lib/cli/setup.sh"; owm_cli_setup "$@"
		;;
	waybar)
		owm_ensure_setup
		shift; owm_source "lib/cli/waybar.sh"; owm_cli_waybar "$@"
		;;
	-h|--help|help|"")
		owm_usage
		;;
	*)
		owm_die "unknown command: $1"
		;;
esac
